<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TitanShop</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-color: #0f0f0f; --card-bg: #1a1a1a; --primary: #00d4ff;
            --primary-hover: #00b8e6; --text-primary: #ffffff; --text-secondary: #a0a0a0;
            --border: #2a2a2a; --success: #00ff88; --danger: #ff3b3b; --warning: #ffaa00;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: var(--bg-color); color: var(--text-primary); padding: 0; margin: 0; overflow-x: hidden;
        }
        .header { position: sticky; top: 0; background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
            padding: 16px 20px; border-bottom: 1px solid var(--border); z-index: 100; backdrop-filter: blur(10px); }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto; }
        .logo { font-size: 24px; font-weight: bold; background: linear-gradient(135deg, var(--primary), #00ff88);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: flex; align-items: center; gap: 8px; }
        .header-btns { display: flex; gap: 12px; }
        .cart-btn, .admin-btn { position: relative; background: var(--card-bg); border: 1px solid var(--primary);
            padding: 10px 20px; border-radius: 20px; color: var(--text-primary); cursor: pointer; font-size: 16px;
            display: flex; align-items: center; gap: 8px; transition: all 0.3s ease; }
        .admin-btn { border-color: var(--warning); }
        .cart-btn:hover, .admin-btn:hover { background: var(--primary); transform: scale(1.05); }
        .admin-btn:hover { background: var(--warning); color: #000; }
        .cart-badge { position: absolute; top: -8px; right: -8px; background: var(--danger); color: white;
            border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center;
            justify-content: center; font-size: 12px; font-weight: bold; }
        .categories { display: flex; gap: 12px; padding: 20px; overflow-x: auto; scrollbar-width: none;
            max-width: 1200px; margin: 0 auto; }
        .categories::-webkit-scrollbar { display: none; }
        .category-btn { padding: 12px 24px; background: var(--card-bg); border: 1px solid var(--border);
            border-radius: 25px; color: var(--text-primary); cursor: pointer; white-space: nowrap;
            transition: all 0.3s ease; font-size: 14px; }
        .category-btn:hover, .category-btn.active { background: var(--primary); border-color: var(--primary);
            transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3); }
        .search-container { padding: 0 20px 20px; max-width: 1200px; margin: 0 auto; }
        .search-input { width: 100%; padding: 14px 20px; background: var(--card-bg); border: 1px solid var(--border);
            border-radius: 25px; color: var(--text-primary); font-size: 16px; transition: all 0.3s ease; }
        .search-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 20px rgba(0, 212, 255, 0.2); }
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px; padding: 20px; max-width: 1200px; margin: 0 auto; }
        .product-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 16px;
            overflow: hidden; transition: all 0.3s ease; cursor: pointer; position: relative; }
        .product-card:hover { transform: translateY(-8px); box-shadow: 0 12px 24px rgba(0, 212, 255, 0.2);
            border-color: var(--primary); }
        .product-image { width: 100%; height: 280px; object-fit: cover;
            background: linear-gradient(135deg, #1a1a1a, #2a2a2a); display: block; }
        .product-image-placeholder { width: 100%; height: 280px; background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
            display: flex; align-items: center; justify-content: center; font-size: 48px; color: var(--text-secondary); }
        .product-info { padding: 16px; }
        .product-category { font-size: 12px; color: var(--primary); text-transform: uppercase;
            letter-spacing: 1px; margin-bottom: 8px; }
        .product-name { font-size: 18px; font-weight: bold; margin-bottom: 8px; overflow: hidden;
            text-overflow: ellipsis; white-space: nowrap; }
        .product-description { font-size: 14px; color: var(--text-secondary); margin-bottom: 12px;
            overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2;
            -webkit-box-orient: vertical; line-height: 1.4; }
        .product-footer { display: flex; justify-content: space-between; align-items: center;
            padding-top: 12px; border-top: 1px solid var(--border); }
        .product-price { font-size: 24px; font-weight: bold; color: var(--success); }
        .add-to-cart-btn { background: var(--primary); border: none; padding: 10px 20px;
            border-radius: 20px; color: white; font-weight: bold; cursor: pointer; transition: all 0.3s ease; }
        .add-to-cart-btn:hover { background: var(--primary-hover); transform: scale(1.05); }
        .add-to-cart-btn:disabled { background: var(--text-secondary); cursor: not-allowed; transform: none; }
        .stock-badge { position: absolute; top: 12px; right: 12px; padding: 6px 12px;
            border-radius: 12px; font-size: 12px; font-weight: bold; }
        .in-stock { background: var(--success); color: #000; }
        .out-of-stock { background: var(--danger); color: white; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); z-index: 1000; overflow-y: auto; }
        .modal.active { display: flex; align-items: flex-start; justify-content: center; padding: 20px; }
        .modal-content { background: var(--card-bg); border-radius: 20px; max-width: 600px; width: 100%;
            margin: 20px auto; border: 1px solid var(--border); animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex;
            justify-content: space-between; align-items: center; }
        .modal-title { font-size: 24px; font-weight: bold; }
        .close-btn { background: none; border: none; color: var(--text-primary); font-size: 28px;
            cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center;
            justify-content: center; border-radius: 50%; transition: all 0.3s ease; }
        .close-btn:hover { background: var(--danger); }
        .modal-body { padding: 20px; max-height: 70vh; overflow-y: auto; }
        .cart-item { display: flex; gap: 16px; padding: 16px; background: var(--bg-color);
            border-radius: 12px; margin-bottom: 12px; border: 1px solid var(--border); }
        .cart-item-image { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; background: var(--card-bg); }
        .cart-item-info { flex: 1; }
        .cart-item-name { font-weight: bold; margin-bottom: 4px; }
        .cart-item-price { color: var(--success); font-size: 18px; }
        .cart-item-controls { display: flex; align-items: center; gap: 12px; margin-top: 8px; }
        .qty-btn { background: var(--primary); border: none; width: 32px; height: 32px;
            border-radius: 50%; color: white; font-size: 18px; cursor: pointer; transition: all 0.3s ease; }
        .qty-btn:hover { background: var(--primary-hover); transform: scale(1.1); }
        .qty-display { font-size: 18px; font-weight: bold; min-width: 30px; text-align: center; }
        .remove-btn { background: var(--danger); border: none; padding: 8px 16px;
            border-radius: 8px; color: white; cursor: pointer; margin-left: auto; }
        .cart-total { padding: 20px; border-top: 1px solid var(--border); background: var(--bg-color);
            border-radius: 0 0 20px 20px; }
        .total-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 16px; }
        .total-row.final { font-size: 24px; font-weight: bold; color: var(--success);
            padding-top: 12px; border-top: 2px solid var(--border); }
        .checkout-btn { width: 100%; padding: 16px; background: linear-gradient(135deg, var(--primary), var(--success));
            border: none; border-radius: 12px; color: white; font-size: 18px; font-weight: bold;
            cursor: pointer; margin-top: 16px; transition: all 0.3s ease; }
        .checkout-btn:hover { transform: scale(1.02); box-shadow: 0 8px 20px rgba(0, 212, 255, 0.4); }
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
        .empty-state-icon { font-size: 64px; margin-bottom: 16px; opacity: 0.5; }
        .loading { text-align: center; padding: 40px; font-size: 18px; color: var(--text-secondary); }
        
        .admin-container { padding: 20px; max-width: 1200px; margin: 0 auto; }
        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .admin-title { font-size: 28px; font-weight: bold; }
        .btn-primary { background: var(--primary); border: none; padding: 12px 24px; border-radius: 12px;
            color: white; font-weight: bold; cursor: pointer; transition: all 0.3s ease; }
        .btn-primary:hover { background: var(--primary-hover); transform: scale(1.05); }
        .btn-success { background: var(--success); color: #000; }
        .btn-danger { background: var(--danger); color: white; }
        .admin-table { width: 100%; background: var(--card-bg); border-radius: 12px; overflow: hidden;
            border: 1px solid var(--border); }
        .admin-table th { background: var(--bg-color); padding: 16px; text-align: left;
            border-bottom: 1px solid var(--border); font-weight: bold; }
        .admin-table td { padding: 16px; border-bottom: 1px solid var(--border); }
        .admin-table tr:last-child td { border-bottom: none; }
        .admin-table tr:hover { background: var(--bg-color); }
        .action-btns { display: flex; gap: 8px; }
        .btn-small { padding: 6px 12px; font-size: 14px; border-radius: 8px; border: none;
            cursor: pointer; transition: all 0.3s ease; }
        .btn-edit { background: var(--primary); color: white; }
        .btn-delete { background: var(--danger); color: white; }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: bold; }
        .form-input, .form-textarea, .form-select { width: 100%; padding: 12px; background: var(--bg-color);
            border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);
            font-size: 16px; transition: all 0.3s ease; }
        .form-input:focus, .form-textarea:focus, .form-select:focus { outline: none;
            border-color: var(--primary); box-shadow: 0 0 10px rgba(0, 212, 255, 0.2); }
        .form-textarea { min-height: 100px; resize: vertical; }
        .form-checkbox { width: auto; margin-right: 8px; }
        .form-row { display: flex; gap: 16px; }
        .form-row .form-group { flex: 1; }
        .auth-container { max-width: 400px; margin: 100px auto; padding: 40px;
            background: var(--card-bg); border-radius: 20px; border: 1px solid var(--border); }
        .auth-title { font-size: 28px; font-weight: bold; text-align: center; margin-bottom: 32px; }
        .product-img-preview { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; }
    </style>
</head>
<body>
    <div id="userView">
        <div class="header">
            <div class="header-content">
                <div class="logo">üèãÔ∏è TitanShop</div>
                <div class="header-btns">
                    <button class="admin-btn" id="adminBtn">‚öôÔ∏è –ê–¥–º–∏–Ω</button>
                    <button class="cart-btn" id="cartBtn">
                        üõí –ö–æ—Ä–∑–∏–Ω–∞
                        <span class="cart-badge" id="cartBadge">0</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="search-container">
            <input type="text" class="search-input" placeholder="üîé –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤..." id="searchInput">
        </div>

        <div class="categories" id="categories">
            <button class="category-btn active" data-category="all">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</button>
            <button class="category-btn" data-category="inject">üíâ –ò–Ω—ä–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ</button>
            <button class="category-btn" data-category="oral">üíä –û—Ä–∞–ª—å–Ω—ã–µ</button>
        </div>

        <div class="products-grid" id="productsGrid">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</div>
        </div>
    </div>

    <div id="adminView" style="display: none;">
        <div class="header">
            <div class="header-content">
                <div class="logo">‚öôÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</div>
                <button class="admin-btn" id="exitAdminBtn">‚Üê –í—ã—Ö–æ–¥</button>
            </div>
        </div>

        <div class="admin-container">
            <div class="admin-header">
                <div class="admin-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏</div>
                <button class="btn-primary" id="addProductBtn">+ –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
            </div>

            <div style="overflow-x: auto;">
                <table class="admin-table" id="adminTable">
                    <thead>
                        <tr>
                            <th>–§–æ—Ç–æ</th>
                            <th>ID</th>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                            <th>–¶–µ–Ω–∞ (‚Ç¨)</th>
                            <th>–í –Ω–∞–ª–∏—á–∏–∏</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="adminTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal" id="authModal">
        <div class="auth-container">
            <div class="auth-title">üîê –í—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</div>
            <div class="form-group">
                <label class="form-label">–ü–∞—Ä–æ–ª—å</label>
                <input type="password" class="form-input" id="adminPassword" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
            </div>
            <button class="btn-primary" id="loginBtn" style="width: 100%;">–í–æ–π—Ç–∏</button>
            <button class="btn-danger" id="cancelAuthBtn" style="width: 100%; margin-top: 12px;">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <div class="modal" id="cartModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üõí –ö–æ—Ä–∑–∏–Ω–∞</div>
                <button class="close-btn" id="closeCartBtn">√ó</button>
            </div>
            <div class="modal-body" id="cartItems"></div>
        </div>
    </div>

    <div class="modal" id="productModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="productModalTitle"></div>
                <button class="close-btn" id="closeProductBtn">√ó</button>
            </div>
            <div class="modal-body" id="productModalBody"></div>
        </div>
    </div>

    <div class="modal" id="editProductModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="editModalTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä</div>
                <button class="close-btn" id="closeEditBtn">√ó</button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="editProductId">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</label>
                            <input type="text" class="form-input" id="editName" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                            <select class="form-select" id="editCategory" required>
                                <option value="–û—Ä–∞–ª—å–Ω—ã–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã">üíä –û—Ä–∞–ª—å–Ω—ã–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã</option>
                                <option value="–ò–Ω—ä–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã">üíâ –ò–Ω—ä–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">–¶–µ–Ω–∞ (‚Ç¨)</label>
                            <input type="number" class="form-input" id="editPrice" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
                            <input type="text" class="form-input" id="editImage" placeholder="–ò–º—è —Ñ–∞–π–ª–∞">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea class="form-textarea" id="editDescription" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" class="form-checkbox" id="editInStock">
                            <span class="form-label" style="display: inline;">–í –Ω–∞–ª–∏—á–∏–∏</span>
                        </label>
                    </div>
                    <button type="submit" class="btn-primary" style="width: 100%;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram?.WebApp || {
            ready: () => {}, expand: () => {}, close: () => {},
            sendData: (data) => console.log('Mock sendData:', data),
            showPopup: (params) => alert(params.message),
            HapticFeedback: { impactOccurred: () => {} }
        };
        tg.ready();
        tg.expand();

        let products = [];
        let cart = {};
        let currentFilter = 'all';
        const ADMIN_PASSWORD = 'admin123';
        let isAdmin = false;

        const IMAGES_BASE64 = {};

        function getLocalImage(url) {
            if (!url) return null;
            const filename = url.split('/').pop();
            return IMAGES_BASE64[filename] || null;
        }

        async function loadProducts() {
            try {
                const stored = localStorage.getItem('products');
                if (stored) {
                    products = JSON.parse(stored);
                    renderProducts();
                    return;
                }
            } catch (e) {}

            const csvData = `ID,Name,Category,Price,Description,Image,InStock
1238,Clomiphene Citrate 25 mg ‚Äì UTINON,–û—Ä–∞–ª—å–Ω—ã–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã,33.0,–ö–ª–æ–º–∏—Ñ–µ–Ω–∞ —Ü–∏—Ç—Ä–∞—Ç (–ö–ª–æ–º–∏–¥) ‚Äî –≥–ª–∞–≤–Ω—ã–π –ø—Ä–µ–ø–∞—Ä–∞—Ç –¥–ª—è –ü–ö–¢.,clonon-600x800-1.png,1
1241,Clenbuterol 40 mcg ‚Äì UTINON,–û—Ä–∞–ª—å–Ω—ã–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã,27.0,–ö–ª–µ–Ω–±—É—Ç–µ—Ä–æ–ª –≥–∏–¥—Ä–æ—Ö–ª–æ—Ä–∏–¥ ‚Äî –º–æ—â–Ω—ã–π –∂–∏—Ä–æ—Å–∂–∏–≥–∞—Ç–µ–ª—å.,clenon-600x800-1.png,1
1244,Cianon ‚Äì Tadalafil 10 mg ‚Äì UTINON,–û—Ä–∞–ª—å–Ω—ã–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã,25.0,–¢–∞–¥–∞–ª–∞—Ñ–∏–ª ‚Äî —Ç–æ–ø–æ–≤—ã–π –ø—Ä–µ–ø–∞—Ä–∞—Ç –¥–ª—è –º–æ—â–Ω–æ–π —ç—Ä–µ–∫—Ü–∏–∏ –¥–æ 36 —á–∞—Å–æ–≤.,cianon-1-600x800-1.png,1`;

            const lines = csvData.trim().split('\n');
            products = lines.slice(1).map(line => {
                const parts = line.split(',');
                return {
                    id: parts[0],
                    name: parts[1],
                    category: parts[2],
                    price: parseFloat(parts[3]),
                    description: parts[4],
                    image: parts[5],
                    inStock: parts[6] === '1'
                };
            });

            await saveProducts();
            renderProducts();
        }

        async function saveProducts() {
            try {
                localStorage.setItem('products', JSON.stringify(products));
            } catch (e) {
                console.log('Storage not available');
            }
        }

        function renderProducts() {
            const grid = document.getElementById('productsGrid');
            const searchInput = document.getElementById('searchInput');
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            
            let filtered = products.filter(p => {
                const matchesSearch = p.name.toLowerCase().includes(searchTerm) || p.description.toLowerCase().includes(searchTerm);
                const matchesCategory = currentFilter === 'all' || 
                    (currentFilter === 'inject' && p.category.includes('–ò–Ω—ä–µ–∫—Ü')) ||
                    (currentFilter === 'oral' && p.category.includes('–û—Ä–∞–ª—å'));
                return matchesSearch && matchesCategory;
            });

            if (filtered.length === 0) {
                grid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîç</div><div>–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div></div>';
                return;
            }

            grid.innerHTML = filtered.map(p => {
                const localImg = getLocalImage(p.image);
                return `
                <div class="product-card" data-id="${p.id}">
                    <span class="stock-badge ${p.inStock ? 'in-stock' : 'out-of-stock'}">
                        ${p.inStock ? '‚úÖ –í –Ω–∞–ª–∏—á–∏–∏' : '‚ùå –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏'}
                    </span>
                    ${localImg ? 
                        `<img src="${localImg}" alt="${p.name}" class="product-image">` : 
                        `<div class="product-image-placeholder">üíä</div>`
                    }
                    <div class="product-info">
                        <div class="product-category">${p.category}</div>
                        <div class="product-name">${p.name}</div>
                        <div class="product-description">${p.description}</div>
                        <div class="product-footer">
                            <div class="product-price">‚Ç¨${p.price}</div>
                            <button class="add-to-cart-btn" data-id="${p.id}" ${!p.inStock ? 'disabled' : ''}>
                                ${p.inStock ? 'üõí –í –∫–æ—Ä–∑–∏–Ω—É' : '–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏'}
                            </button>
                        </div>
                    </div>
                </div>`;
            }).join('');

            document.querySelectorAll('.product-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('add-to-cart-btn')) {
                        showProductDetail(card.dataset.id);
                    }
                });
            });

            document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    addToCart(btn.dataset.id);
                });
            });
        }

        function showProductDetail(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;
            const localImg = getLocalImage(product.image);
            
            document.getElementById('productModalTitle').textContent = product.name;
            document.getElementById('productModalBody').innerHTML = `
                ${localImg ? 
                    `<img src="${localImg}" alt="${product.name}" style="width: 100%; height: 400px; object-fit: cover; border-radius: 12px;">` : 
                    `<div class="product-image-placeholder" style="height: 400px;">üíä</div>`
                }
                <div style="padding: 24px 0;">
                    <div style="color: var(--primary); font-size: 14px; text-transform: uppercase; margin-bottom: 8px;">${product.category}</div>
                    <div style="font-size: 28px; font-weight: bold; margin-bottom: 16px;">${product.name}</div>
                    <div style="color: var(--text-secondary); line-height: 1.6; margin-bottom: 24px;">${product.description}</div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 20px; border-top: 1px solid var(--border);">
                        <div style="font-size: 32px; font-weight: bold; color: var(--success);">‚Ç¨${product.price}</div>
                        <button class="add-to-cart-btn" data-id="${product.id}" ${!product.inStock ? 'disabled' : ''}>
                            ${product.inStock ? 'üõí –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É' : '‚ùå –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏'}
                        </button>
                    </div>
                </div>`;
            
            const btn = document.getElementById('productModalBody').querySelector('.add-to-cart-btn');
            if (btn) {
                btn.addEventListener('click', () => {
                    addToCart(btn.dataset.id);
                    closeProductDetail();
                });
            }
            
            document.getElementById('productModal').classList.add('active');
        }

        function closeProductDetail() {
            document.getElementById('productModal').classList.remove('active');
        }

        function addToCart(id) {
            const product = products.find(p => p.id === id);
            if (!product || !product.inStock) return;
            cart[id] = (cart[id] || 0) + 1;
            updateCartBadge();
            tg.HapticFeedback.impactOccurred('medium');
            alert(`‚úÖ ${product.name} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É`);
        }

        function updateCartBadge() {
            const count = Object.values(cart).reduce((a, b) => a + b, 0);
            document.getElementById('cartBadge').textContent = count;
            document.getElementById('cartBadge').style.display = count > 0 ? 'flex' : 'none';
        }

        function openCart() {
            const cartItemsDiv = document.getElementById('cartItems');
            if (Object.keys(cart).length === 0) {
                cartItemsDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üõçÔ∏è</div>
                        <div>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞. –î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã!</div>
                    </div>
                    <div class="cart-total">
                        <div class="total-row final">
                            <span>–ò—Ç–æ–≥–æ:</span>
                            <span>‚Ç¨0.00</span>
                        </div>
                    </div>`;
                document.getElementById('cartModal').classList.add('active');
                return;
            }

            let total = 0;
            let itemsHtml = '';

            for (const id in cart) {
                const product = products.find(p => p.id === id);
                if (!product) continue;

                const quantity = cart[id];
                const itemTotal = quantity * product.price;
                total += itemTotal;
                const localImg = getLocalImage(product.image);

                itemsHtml += `
                    <div class="cart-item">
                        ${localImg ? 
                            `<img src="${localImg}" alt="${product.name}" class="cart-item-image">` : 
                            `<div class="cart-item-image" style="display: flex; align-items: center; justify-content: center; font-size: 30px;">üíä</div>`
                        }
                        <div class="cart-item-info">
                            <div class="cart-item-name">${product.name}</div>
                            <div class="cart-item-price">‚Ç¨${itemTotal.toFixed(2)}</div>
                            <div class="cart-item-controls">
                                <button class="qty-btn" data-id="${id}" data-change="-1">-</button>
                                <span class="qty-display">${quantity}</span>
                                <button class="qty-btn" data-id="${id}" data-change="1">+</button>
                                <button class="remove-btn" data-id="${id}">–£–¥–∞–ª–∏—Ç—å</button>
                            </div>
                        </div>
                    </div>`;
            }

            cartItemsDiv.innerHTML = itemsHtml + `
                <div class="cart-total">
                    <div class="total-row">
                        <span>–¢–æ–≤–∞—Ä—ã:</span>
                        <span>‚Ç¨${total.toFixed(2)}</span>
                    </div>
                    <div class="total-row final">
                        <span>–ò—Ç–æ–≥–æ:</span>
                        <span>‚Ç¨${total.toFixed(2)}</span>
                    </div>
                    <button class="checkout-btn" id="checkoutBtn">
                        –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ (–≤—Å–µ–≥–æ ‚Ç¨${total.toFixed(2)})
                    </button>
                </div>`;

            document.querySelectorAll('.qty-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    updateQuantity(btn.dataset.id, parseInt(btn.dataset.change));
                });
            });

            document.querySelectorAll('.remove-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    delete cart[btn.dataset.id];
                    updateCartBadge();
                    openCart();
                });
            });

            document.getElementById('checkoutBtn').addEventListener('click', sendOrderData);
            document.getElementById('cartModal').classList.add('active');
        }

        function closeCart() {
            document.getElementById('cartModal').classList.remove('active');
        }

        function updateQuantity(id, change) {
            cart[id] = (cart[id] || 0) + change;
            if (cart[id] <= 0) {
                delete cart[id];
            }
            tg.HapticFeedback.impactOccurred('light');
            updateCartBadge();
            openCart();
        }

        function sendOrderData() {
            const order = [];
            let total = 0;

            for (const id in cart) {
                const product = products.find(p => p.id === id);
                if (!product) continue;
                const quantity = cart[id];
                const itemTotal = quantity * product.price;
                total += itemTotal;
                order.push({ name: product.name, qty: quantity, price: product.price, total: itemTotal });
            }

            if (order.length === 0) {
                alert('‚ùå –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞!');
                return;
            }

            let message = 'üõí *–ù–û–í–´–ô –ó–ê–ö–ê–ó TITANSHOP* üõí\n\n';
            order.forEach(item => {
                message += `‚ñ™Ô∏è *${item.name}* (x${item.qty}) - ‚Ç¨${item.total.toFixed(2)}\n`;
            });
            message += `\n*–ò–¢–û–ì–û: ‚Ç¨${total.toFixed(2)}*`;

            tg.sendData(JSON.stringify({
                type: 'order',
                message: message,
                order_details: order,
                total: total
            }));

            tg.HapticFeedback.impactOccurred('heavy');
            alert('üöÄ –ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω! –í–∞—à –∑–∞–∫–∞–∑ –ø–µ—Ä–µ–¥–∞–Ω –º–µ–Ω–µ–¥–∂–µ—Ä—É. –° –í–∞–º–∏ —Å–∫–æ—Ä–æ —Å–≤—è–∂—É—Ç—Å—è.');

            cart = {};
            updateCartBadge();
            closeCart();
        }

        function showAdminAuth() {
            document.getElementById('adminPassword').value = '';
            document.getElementById('authModal').classList.add('active');
        }

        function closeAuthModal() {
            document.getElementById('authModal').classList.remove('active');
        }

        function checkAdminPassword() {
            const password = document.getElementById('adminPassword').value;
            if (password === ADMIN_PASSWORD) {
                isAdmin = true;
                closeAuthModal();
                showAdminPanel();
            } else {
                alert('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!');
            }
        }

        function showAdminPanel() {
            document.getElementById('userView').style.display = 'none';
            document.getElementById('adminView').style.display = 'block';
            renderAdminTable();
        }

        function exitAdmin() {
            isAdmin = false;
            document.getElementById('userView').style.display = 'block';
            document.getElementById('adminView').style.display = 'none';
        }

        function renderAdminTable() {
            const tbody = document.getElementById('adminTableBody');
            tbody.innerHTML = products.map(p => {
                const localImg = getLocalImage(p.image);
                return `
                    <tr>
                        <td>
                            ${localImg ? 
                                `<img src="${localImg}" class="product-img-preview">` : 
                                '<div style="width: 80px; height: 80px; background: var(--bg-color); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 32px;">üíä</div>'
                            }
                        </td>
                        <td>${p.id}</td>
                        <td>${p.name}</td>
                        <td>${p.category}</td>
                        <td>‚Ç¨${p.price.toFixed(2)}</td>
                        <td>${p.inStock ? '‚úÖ –î–∞' : '‚ùå –ù–µ—Ç'}</td>
                        <td>
                            <div class="action-btns">
                                <button class="btn-small btn-edit" data-id="${p.id}">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
                                <button class="btn-small btn-delete" data-id="${p.id}">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            document.querySelectorAll('.btn-edit').forEach(btn => {
                btn.addEventListener('click', () => editProduct(btn.dataset.id));
            });

            document.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', () => deleteProduct(btn.dataset.id));
            });
        }

        function showAddProductModal() {
            document.getElementById('editModalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä';
            document.getElementById('editProductId').value = '';
            document.getElementById('editName').value = '';
            document.getElementById('editCategory').value = '–û—Ä–∞–ª—å–Ω—ã–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã';
            document.getElementById('editPrice').value = '';
            document.getElementById('editDescription').value = '';
            document.getElementById('editImage').value = '';
            document.getElementById('editInStock').checked = true;
            document.getElementById('editProductModal').classList.add('active');
        }

        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;

            document.getElementById('editModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä';
            document.getElementById('editProductId').value = product.id;
            document.getElementById('editName').value = product.name;
            document.getElementById('editCategory').value = product.category;
            document.getElementById('editPrice').value = product.price;
            document.getElementById('editDescription').value = product.description;
            document.getElementById('editImage').value = product.image;
            document.getElementById('editInStock').checked = product.inStock;
            document.getElementById('editProductModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editProductModal').classList.remove('active');
        }

        async function deleteProduct(id) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä?')) return;
            
            products = products.filter(p => p.id !== id);
            await saveProducts();
            renderAdminTable();
            tg.HapticFeedback.impactOccurred('medium');
            alert('‚úÖ –¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω!');
        }

        document.getElementById('productForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const id = document.getElementById('editProductId').value;
            const productData = {
                id: id || Date.now().toString(),
                name: document.getElementById('editName').value,
                category: document.getElementById('editCategory').value,
                price: parseFloat(document.getElementById('editPrice').value),
                description: document.getElementById('editDescription').value,
                image: document.getElementById('editImage').value,
                inStock: document.getElementById('editInStock').checked
            };

            if (id) {
                const index = products.findIndex(p => p.id === id);
                if (index !== -1) {
                    products[index] = productData;
                }
            } else {
                products.push(productData);
            }

            await saveProducts();
            renderAdminTable();
            renderProducts();
            closeEditModal();
            tg.HapticFeedback.impactOccurred('medium');
            alert('‚úÖ –¢–æ–≤–∞—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
        });

        document.getElementById('adminBtn').addEventListener('click', showAdminAuth);
        document.getElementById('cartBtn').addEventListener('click', openCart);
        document.getElementById('closeCartBtn').addEventListener('click', closeCart);
        document.getElementById('closeProductBtn').addEventListener('click', closeProductDetail);
        document.getElementById('loginBtn').addEventListener('click', checkAdminPassword);
        document.getElementById('cancelAuthBtn').addEventListener('click', closeAuthModal);
        document.getElementById('exitAdminBtn').addEventListener('click', exitAdmin);
        document.getElementById('addProductBtn').addEventListener('click', showAddProductModal);
        document.getElementById('closeEditBtn').addEventListener('click', closeEditModal);

        document.getElementById('searchInput').addEventListener('input', renderProducts);

        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                currentFilter = this.dataset.category;
                document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                renderProducts();
            });
        });

        document.addEventListener('DOMContentLoaded', () => {
            loadProducts();
            updateCartBadge();
        });

        loadProducts();
        updateCartBadge();
    </script>
</body>
</html>